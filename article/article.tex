% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  authoryear,
  preprint,
  1p]{elsarticle}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{5}
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi


\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\makeatletter
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[skins,breakable]{tcolorbox}}
\makeatother
\makeatletter
\@ifundefined{shadecolor}{\definecolor{shadecolor}{rgb}{.97, .97, .97}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\makeatother
\journal{Journal Name}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{elsarticle-harv}
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Quantile Regressions via Method of Moments with multiple fixed effects},
  pdfauthor={Fernando Rios-Avila; Leonardo Siles; Gustavo Canavire-Bacarreza},
  pdfkeywords={Fixed effects, Linear heteroskedasticity, Location-scale
model, Quantile regression},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\setlength{\parindent}{6pt}
\begin{document}

\begin{frontmatter}
\title{Quantile Regressions via Method of Moments with multiple fixed
effects}
\author[1]{Fernando Rios-Avila%
\corref{cor1}%
}
 \ead{friosavi@levy.org} 
\author[]{Leonardo Siles%
%
}
 \ead{leo@gmail.com} 
\author[2]{Gustavo Canavire-Bacarreza%
%
}
 \ead{gcanavire@worldbank.org} 

\affiliation[1]{organization={Levy Economics Institute of Bard
College},,postcodesep={}}
\affiliation[2]{organization={World Bank},,postcodesep={}}

\cortext[cor1]{Corresponding author}



        
\begin{abstract}
This paper proposes a new method to estimate quantile regressions with
multiple fixed effects. The method expands on the strategy proposed by
\citet{mss2019}, allowing for multiple fixed effects, and providing
various alternatives for the estimation of Standard errors. We provide
Monte Carlo simulations to show the finite sample properties of the
proposed method in the presence of two sets of fixed effects. Finally,
we apply the proposed method to estimate \textbf{something interesting}
\end{abstract}





\begin{keyword}
    Fixed effects \sep Linear heteroskedasticity \sep Location-scale
model \sep 
    Quantile regression
\end{keyword}
\end{frontmatter}
    \ifdefined\Shaded\renewenvironment{Shaded}{\begin{tcolorbox}[sharp corners, frame hidden, boxrule=0pt, interior hidden, borderline west={3pt}{0pt}{shadecolor}, enhanced, breakable]}{\end{tcolorbox}}\fi

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

Quantile regression (QR), introduced by \citet{koenkerbasset1978}, is an
estimation strategy used for modeling the relationships between
explanatory variables X and the conditional quantiles of the dependent
variable \(q_\tau (y|x)\). Using QR one can obtain richer
characterizations of the relationships between dependent and independent
variables, by accounting for otherwise unobserved heterogeneity.

A relatively recent development in the literature has focused on
extending quantile regressions analysis to include individual fixed
effects in the framework of panel data. However, as described in
\citet{neymanscott1948}, and \citet{lancaster2000}, when individual
fixed effects are included in quantile regression analysis it generates
an incident parameter problem. While many strategies have been proposed
for estimating this type of model (see Galv√£o and Kato, 2018 for a brief
review), neither has become standard because of their restrictive
assumptions in regards to the individual effects, the computational
complexity, and implementation.

More recently, \citet{mss2019} (MSS hereafter) proposed a methodology
based on a conditional location-scale model similar to the one described
in \citet{he1997} and \citet{zhao2000}, for the estimation of quantile
regressions models for panel data via a method of moments. This method
allows individual fixed effects allowing to have heterogeneous effects
on the entire conditional distribution of the outcome, rather
constraining their effect to be a location shift only as in
\citet{canay2011}, \citet{koenker2004}, and \citet{lancaster2000}.

In principle, under the assumption that data generating process behind
the data is based on a multiplicative heteroskedastic process that is
linear in parameters (\citet{cameron2005}, \citet{mss2019},
\citet{he1997} and \citet{zhao2000} ), the effect of a variable \(X\) on
the \(q_th\) quantile can be derived as the combination of a location
effect, and scale effect moderated by the quantile of an underlying
i.i.d. error. For statistical inference, MSS derives the asymptotic
distribution of the estimator, suggesting the use of bootstrap standard
errors, as well.

While this methodology is not meant to substitute the use of standard
quantile regression analysis, given the assumptions required for the
identification of the model, it provides a simple and fast alternative
for the estimation of quantile regression models with individual fixed
effects.

In this framework, our paper expands on \citet{mss2019}, following some
of the suggestions by the authors regarding further research. First,
making use of the properties of GMM estimators, we derive various
alternatives for the estimation of standard errors based on the
empirical Influence functions of the estimators. Second, we reconsider
the application of Frisch--Waugh--Lovell (FWL) theorem
(\citet{frishwaugh1933} and \citet{lovell1963}) to extend the MSS
estimator to allow for the inclusion of multiple fixed effects, for
example, individual and year fixed effects.

The rest of the paper is restructured as follows. Section 2 presents the
basic setup of the location-Scale model described in \citet{he1997} and
\citet{zhao2000}, tying the relationship between the standard quantile
regression model, and the location and scale model. It also revisits MSS
methodology, proposing alternative estimators for the standard errors
based on the properties of GMM estimators and the empirical influence
functions. It also shows that FWL theorem can be used to control for
multiple fixed effects. Section 3 presents the results of a small
simulation study and Section 4 illustrates the application of the
proposed methods with two empirical examples. Seccion 5 concludes.

\hypertarget{methodology}{%
\section{Methodology}\label{methodology}}

\hypertarget{sec-betas}{%
\subsection{Quantile Regression: Location-Scale model}\label{sec-betas}}

Quantile regressions are used to identify relationships between the
explanatory variables \(x\) and the conditional quantiles of the
dependent variable \(Q(y|\tau,X)\). This relationship is commonly
assumed to follow a linear functional form:

\begin{equation}\protect\hypertarget{eq-eq1}{}{q(Y|X,\tau) =X\beta(\tau)
}\label{eq-eq1}\end{equation}

This allows for nonlinearities in the effect of \(X\) on \(Y\) across
all values of \(\tau\). This formulation can also be related to a random
coefficient model, where all coefficients are assumed to be some
nonlinear function of \(\tau\), where \(\tau\) follows a random uniform
distribution.

An alternative formulation of quantile regressions is the location-scale
model. This approach assumes that the conditional quantile of \(Y\)
given \(X\) and \(\tau\) can be expressed as a combination of two
models: the location model, which describes the central tendency of the
conditional distribution, and the scale model, which describes
deviations from the central tendency:

\begin{equation}\protect\hypertarget{eq-eq2}{}{q(Y|X,\tau) =X\beta+X\gamma(\tau)
}\label{eq-eq2}\end{equation}

Here, the location parameters \(\beta\) are typically identified using a
linear regression model (as in \citet{mss2019}), or a median regression
(as in \citet{melly2005}), and the scale parameters \(\gamma(\tau)\) can
be estimated using standard approaches.

Both the standard quantile regression (Equation~\ref{eq-eq1}) and the
location-scale specification (Equation~\ref{eq-eq2}) can be estimated as
the solution to a weighted minimization problem:

\begin{equation}\protect\hypertarget{eq-eq3}{}{\hat{\beta}(\tau) = \underset{\beta}{\operatorname{argmin}}
\left( \sum_{i\in y_i\geq x_i'\beta} \tau (y_i - x_i'\beta) - \sum_{i\in y_i<x_i'\beta} (1-\tau)(y_i - x_i'\beta) \right)
}\label{eq-eq3}\end{equation}

One characteristic of this estimator is that the \(\beta(\tau)\)
coefficients are identified locally, and thus the estimated quantile
coefficients will exhibit considerable variation when analyzed across
\(\tau\). It is also implicit that if one requires an analysis of the
entire distribution, it would be necessary to estimate the model for
each quantile.\footnote{There are other estimators that provide smoother
  estimates for the quantile regression coefficients using a kernel
  local weighted approach \citep{kaplan2017}, as well as identifying the
  full set of quantile coefficients simultaneously assuming some
  parametric functional forms \citep{frumentobotai2016}.}

One insightful extension to the location-scale parameterizations
suggested by \citet{he1997}, \citet{cameron2005}, and \citet{mss2019} is
to assume that the data-generating process (DGP) can be written as a
linear model with a multiplicative heteroskedastic process that is
linear in parameters.\footnote{\citet{mss2019} also discuss a model
  where heteroskedasticity can be an arbitrary nonlinear function
  \(\sigma(x_i'\gamma)\), but develop the estimator for the linear case,
  i.e., when \(\sigma()\) is the identity function.}

\begin{equation}\protect\hypertarget{eq-eq4}{}{\begin{aligned}
y_i &=x_i'\beta+\nu_i \\
\nu_i &=\varepsilon_i \times x_i'\gamma 
\end{aligned}
}\label{eq-eq4}\end{equation}

Under the assumption that \(\varepsilon\) is an independent and
identically distributed (iid) unobserved random variable that is
independent of \(X\), the conditional quantile of \(Y\) given \(X\) and
\(\tau\) can be written as:

\begin{equation}\protect\hypertarget{eq-eq5}{}{q(Y|X,\tau) =X\beta+q(\varepsilon|\tau) \times X\gamma 
}\label{eq-eq5}\end{equation}

In this setup, the traditional quantile coefficients are identified as
the location model coefficients, plus the scale model coefficients
moderated by the \(\tau_th\) unconditional quantile of the standardized
error \(\varepsilon\).

\begin{equation}\protect\hypertarget{eq-eq6}{}{\beta(\tau) = \beta + q(\varepsilon|\tau) \times \gamma 
}\label{eq-eq6}\end{equation}

While this specification imposes a strong assumption on the DGP, it has
two advantages over the standard quantile regression model. First,
because the location and scale model can be identified globally, with
only a single parmater (\(q(\varepsilon|\tau)\)) requiring local
estimation, this estimation approach would be more efficient than the
standard quantile regression model (\citet{zhao2000}). Second, under the
assumption that \(X\gamma\) is strictly possitive, the model would
produce quantile coefficients that do not cross.

Following MSS, the quantile regression model defined by
Equation~\ref{eq-eq5} can be estimated using a method of moments
approach. And while its possible to identify all coefficients
(\(\beta,\gamma, q(\varepsilon|\tau)\)) simultaneously, we describe and
use the implementation approach advocated by MSS which identifies each
set of coefficients separately.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The location model can be estimated using a standard linear regression
  model, where the dependent variable is the outcome \(Y\), and the
  independent variables are the explanatory variables \(X\) (including a
  constant) with an error \(u\), which is by definition heteroskedastic.
  In this case, the location model coefficients are identified under the
  following condition:
\end{enumerate}

\begin{equation}\protect\hypertarget{eq-eq7}{}{\begin{aligned}
      y_i &=x_i'\beta+\nu_i \\
      E\big[ x_i \nu_i\big] &=0
      \end{aligned}
}\label{eq-eq7}\end{equation}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  After the location model is estimated, the scale coefficients can be
  identified by modeling heteroskedasticity as a linear function of
  characteristics \(X\). For this we use the absolute value of the
  errors from the location model \(u\) as dependent variable, which
  would allow us to estimate the conditional standard deviation (rather
  than conditional variance) of the errors. In this case, the
  coefficients are identified under the following condition:
\end{enumerate}

\begin{equation}\protect\hypertarget{eq-eq8}{}{\begin{aligned}
  |\nu_i| &=x_i'\gamma+\omega_i \\
  E\big[ x_i \omega_i \big] &=0 \\
  E\big[ x_i (|\nu_i| -x_i'\gamma ) \big] &=0
  \end{aligned}
}\label{eq-eq8}\end{equation}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Finally, given the location and scale coefficients, the \(\tau_{th}\)
  quantile of the error \(e\) can be estimated using the following
  condition:
\end{enumerate}

\begin{equation}\protect\hypertarget{eq-eq9}{}{\begin{aligned}
  E\left[  \mathbb{1}\left(x_i' (\beta + \gamma q(\varepsilon|\tau)) \geq y_i \right) - \tau \right] &=0  \\
  E\left[  \mathbb{1}\left(   q(\varepsilon|\tau)\geq \frac{y_i-x_i'\beta}{x_i'\gamma} \right) - \tau \right] &=0  \\
  \end{aligned}
}\label{eq-eq9}\end{equation}

Where one identifies the quantile of the error \(\varepsilon\) using
standardized errors \(\frac{y_i-x_i'\beta}{x_i'\gamma}\), or by finding
the values that identify the overall quantile coefficients
\(\beta(\tau)=\beta + \gamma q(\varepsilon|\tau)\). Afterwords, the
conditional quantile coefficients is simply defined as the combination
of the location and scale coefficients.

\hypertarget{sec-se}{%
\subsection{Standard Errors: GLS, Robust, Clustered}\label{sec-se}}

As discussed in the previous section, the estimation of quantile
regression coefficients using the location-scale model with
heteroskedstic linear errors can be estimated using a the following set
of moments, which fits in the Generalized Method of Moments framework:

\begin{equation}\protect\hypertarget{eq-eq10}{}{\begin{aligned}
  E[x_i \nu_i  ] &= E[h_{1,i}]=0 \\
  E[x_i  (|\nu_i|-x_i \gamma) ] &=E[h_{2,i}]=0 \\
  E\left[  \mathbb{1}\left(   q(\varepsilon|\tau)\geq \frac{y_i-x_i'\beta}{x_i'\gamma} \right) - \tau \right] 
  &=E[h_{3,i}]=0 
  \end{aligned}
}\label{eq-eq10}\end{equation}

Under the conditions described in \citet{newey_chapter_1994} (see
section 7), \citet{cameron2005} (see chapter 6.3.9) or as shown in
\citet{mss2019}, the location, scale and residual quantile coefficients
are asymptotically normal.\footnote{\citet{zhao2000} also shows that the
  quantile coefficients for the location-scale model also follows a
  normal distribution, but uses the assumption that the location model
  is derived using a least absolute deviation approach (median
  regression).}

Call \(\theta=[ \beta' \ \ \gamma' \ \ q(\varepsilon|\tau)' ]'\) the set
of coefficients that are identified by the modement conditions in
Equation~\ref{eq-eq10}, a just identified model. And the function
\(h_i\) is a vector function that stacks all the moments at the
individual level described in Equation~\ref{eq-eq10}. Then
\(\hat\theta\) follows a normal distribution with mean \(\theta\) and
variance-covariance matrix \(V(\theta)\) that is estimated as:

\[
\hat{V}(\hat\theta)=\frac{1}{N} 
\bar G(\hat\theta)^{-1} 
\left( \frac{1}{N} \sum_{i=1}^N h_i h_i'  \Big|_{\theta=\hat\theta} \right) 
\bar G(\hat\theta)^{-1} 
\]

Which is equivalent to the Eicker-White Heteroskedastic-Consistent
estimator for least-squares estimators.

Here, the inner product is the moment covariance matrix, and
\(\bar{G}(\theta)\) is the Jacobian matrix of the moment equations
(Equation~\ref{eq-eq10}) evaluated at \(\hat\theta\).

\[\bar{G}(\theta) =-\frac{1}{N} \sum_{i=1} \frac{\partial h_i}{\partial \theta'} \Big|_{\theta=\hat\theta}\]

In this framework, the quantile regression coefficients, a combination
of the location-scale-quantile estimates, will follow a normal
distribution with mean \(\beta(\tau) = \beta+q(\varepsilon|\tau)\gamma\)
and variance-covariance matrix equal to:

\[\hat{V}(\beta(\tau)) = \Xi \hat{V}(\hat\theta) \Xi'
\]

where \(\Xi\) is a \(k \times (2k+1)\) matrix defined as:

\[\Xi = [ I(k), \hat q(\varepsilon|\tau) \times I(k), \hat \gamma ]
\]

with \(I(k)\) being an identity matrix of dimension \(k\) (number of
explanatory variables in \(X\) including the constant).

While it is possible to estimate the variance-covariance matrix using
simultaneous model estimation, for a just identified model, it is more
efficient to estimate each set of coefficients separately. The
variance-covariance matrix can be estimated using the empirical
influence functions of the estimators (see \citet{jann_2020} for an
overview of the application, and \citet{hampel2005} for an in-depth
review).

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Need to add the general condition Var=(inf (theta) * inf(theta))
\end{enumerate}

Thatn inf(theta) = inf beta gamma and q)tay

and finally define what the IFs are (see appendix)

The different types of Standard errors estimation, thus, depend on the
assumptions imposed for the estimation of \(V(\theta)\).

\hypertarget{robust-standard-errors}{%
\subsubsection{Robust Standard Errors}\label{robust-standard-errors}}

Cross product of IFs

\hypertarget{clustered-standard-errors}{%
\subsubsection{Clustered Standard
Errors}\label{clustered-standard-errors}}

Sun then cross product

\hypertarget{gls-standard-errors}{%
\subsubsection{GLS Standard Errors}\label{gls-standard-errors}}

Original paper;

\hypertarget{multiple-fixed-effects-expanding-on-mss2019}{%
\subsection{\texorpdfstring{Multiple Fixed Effects: Expanding on
\citet{mss2019}}{Multiple Fixed Effects: Expanding on @mss2019}}\label{multiple-fixed-effects-expanding-on-mss2019}}

Using the setup described in the previous section, \citet{mss2019}
proposes an extension to the model proposed by \citet{he1997} that would
allow for the estimation of quantile regression models with panel data,
allowing for the inclusion of individual fixed effects. However, as the
authors suggest, the methodology can be generalized to allow for the
inclusion of multiple fixed effects. This type of analysis may be useful
when considering data such as employer-employee linked data
\citep{abowed2006}, or teacher-student linked data
\citep{harrissass2011}. Or, in the most common case, allowing to control
for both individual and time fixed effects.

Reconsider the original model, and assume there are sets of unobserved
heterogeneity that are assumed to be constant across observations, if
they belong to common groups. In panel data, the groups would be the
individual fixed effects and the time fixed effects. Without loss of
generality, we can assume that the data generating process is as
follows:

\[\begin{aligned}
  y_{i} &= x_{i}' \beta + \delta_{g1} + \delta_{g2} + \nu_i \\
  \nu_i &= \varepsilon_i \times (x_{i}' \gamma + \zeta_{g1} + \zeta_{g2})   
  \end{aligned}
\]

where we assume \(x_{i}\) vary across groups \(g_1\) and \(g_2\), thus
are not collinear, and that \(\delta's\) and \(\zeta's\) are the
location and scale effects associated with groups fixed
effects.\footnote{We could just as well consider multiple sets of fixed
  effects}

If the dimension of groups \(g_k\) is low, this model could be estimated
using a dummy inclussion approach following Section~\ref{sec-betas}, and
standard errors obtained as discussed in Section~\ref{sec-se}. However,
if the dimensionality of \(g_k\) is high, the dummy inclusion approach
may not be feasible. Instead, a more feasible approach is to apply the
Frisch-Waugh-Lovell (FWL) theorem, and partial out the impact of the
group fixed effects on the control variables \(x_{i}\), the outcome of
interest \(y_{i}\), with a similar approach for the identification of
\(\sigma(x)\). In the case of unbalanced setups, with multiple groups,
the estimation involves iterative processes for which various approaches
have been suggested and implemented (see
\citet{correia_feasible_nodate}, \citet{gaure2013}, \citet{rios2015},
among others).

When applying the partialing out approach, some modifications to the
approach described in Section~\ref{sec-betas} are needed.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  For all dependent and independent variables in the model (\(w=y,x\)),
  we partial out the group fixed effects, and obtain the
  centered-residualized variables:
\end{enumerate}

\[\begin{aligned}
w_{i} &= \delta_{g1}^w + \delta_{g2}^w + u_{i}^w \\
w_{i}^{rc} &= E(w_{i}) + \hat{u}_{i}^w
\end{aligned}
\]

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  We estimate the location model using the centered-residualized
  variables:
\end{enumerate}

\[y_{i}^{rc} = x_{i}^{rc'} \beta + nu_{i}
\]

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Since \(|\hat \nu_i|\) is the dependent variable for the scale model,
  we apply the partialling out and recentering to this expression
  (\(|\hat \nu_i|^{rc}\)), and use that to estimate the model:
\end{enumerate}

\[|\hat\nu_{i}|^{rc} = x_{i}^{rc'} \gamma + e_{i}\]

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Finally the standardized residuals \(\varepsilon_i\) can be obtained
  as follows
\end{enumerate}

\[\hat{\varepsilon}_{i} = \frac{\nu_{i}}{|\hat\nu_{i}|- \hat e_{i}}\]

where \(|\hat\nu_{i}|- \hat e_{i}\) is the prediction for the
conditional standard deviation
\(\sigma(x_i)=x_{i}' \gamma + \zeta_{g1} + \zeta_{g2}\)

The \(\tau_{th}\) quantile of the error \(\varepsilon\) can be estimated
as usual, and the variance-covariance matrices obtained in the same way
as before (see Section~\ref{sec-se}), but using \(x_{i}^{rc}\) instead
of \(x_{i}\) when estimating the influence functions for all estimated
coefficients.

\hypertarget{monte-carlo-simulations}{%
\section{Monte Carlo Simulations}\label{monte-carlo-simulations}}

\hypertarget{application-something-interesting}{%
\section{\texorpdfstring{Application: \textbf{Something
interesting}}{Application: Something interesting}}\label{application-something-interesting}}

\hypertarget{conclusions}{%
\section{Conclusions}\label{conclusions}}

\hypertarget{appendix}{%
\section{Appendix}\label{appendix}}

\hypertarget{model-identification}{%
\subsection{Model Identification}\label{model-identification}}

The estimation of quantile regression via moments assumes that the DGP
is linear in parameters, with an heteroskedastic error term that is also
linear function of parameters:

\[\begin{aligned}
y = x\beta + \nu \\
\nu = \varepsilon \times x\gamma
\end{aligned}
\]

where \(\varepsilon\) is an unobserved i.i.d. random variable that is
independent of \(x\), and such that \(x\gamma\) is larger than zero for
any \(x\).

In this case, the \(\tau_{th}\) conditional quantile model can be
written as:

\[q(y|\tau,X) = x(\beta + q(\varepsilon |\tau) \times \gamma)\]

This model is identified under the following conditions:

\[\begin{aligned}
  E[(y_i-x_i'\beta)x_i ]  &= E[h_{1,i}]=0 \\
  E[ (|y_i-x_i'\beta|-x_i' \gamma) x_i ] &=E[h_{2,i}]=0 \\
  E\left[  \mathbb{1}\left( q(\varepsilon|\tau) x_i'\gamma +x_i'\beta\geq  y_i  \right) - \tau \right] 
   &=E[h_{3,i}]=0 
\end{aligned}
\]

For simplicity, for the rest of the appendix, I will use
\(q^\varepsilon_\tau\) to represent \(q(\varepsilon |\tau)\).

\hypertarget{estimation-of-the-variance-covariance-matrix}{%
\subsection{Estimation of the variance-covariance
matrix}\label{estimation-of-the-variance-covariance-matrix}}

In this model, to estimate the variance-covariance matrix the set of
coefficients \(\theta'=[\beta' \ \gamma' \ q^\varepsilon_\tau]\), we
need to obtain the influence functions of all coefficients, which are
defined as:

\[\lambda_i = \bar G(\theta)^{-1}
\begin{bmatrix}
h_{1,i} \\
h_{2,i} \\
h_{3,i}
\end{bmatrix}
\]

where the Jacobian matrix \(\bar G(\theta)\) is defined as:

\[\bar G(\theta) = \begin{bmatrix}
\bar G_{11} & G_{12} & G_{13} \\
\bar G_{21} & \bar G_{22} & G_{23} \\
\bar G_{31} & \bar G_{32} & \bar G_{13} \\
\end{bmatrix}
\]

with

\[\bar G_{j,k} = - \frac 1 N \sum_{i=1}^N \frac{\partial h_{j,i}}{\partial \theta_k'} \ \forall j,k \in 1,2,3
\]

\hypertarget{first-moment-condition-location-model}{%
\subsubsection{First Moment Condition: Location
Model}\label{first-moment-condition-location-model}}

\[h_{1,i}=x_i(y_i-x_i'\beta)\]

\[\begin{aligned}
\bar G_{1,1} &=- \frac{1}{N} \sum_{i=1}^N \frac{\partial h_{1,i}}{\partial \beta'} \\
             &=- \frac{1}{N} \sum_{i=1}^N (-x_i x_i') \\
             &= N^{-1} X'X
\end{aligned}
\]

\[
\bar G_{1,2} = \bar G_{1,3} = 0
\]

\hypertarget{second-moment-condition-scale-model}{%
\subsubsection{Second Moment Condition: Scale
model}\label{second-moment-condition-scale-model}}

\[h_{2,i}=x_i(|y_i-x_i'\beta|-x_i'\gamma)\]

\[\begin{aligned}
\bar G_{2,1} &= -\frac{1}{N} \sum \frac{\partial h_{2,i}}{\partial \beta'} \\
             &=  \frac{1}{N} \sum x_i x_i' \frac{y_i-x_i'\beta}{|y_i-x_i'\beta|} \\
\frac{y_i-x_i'\beta}{|y_i-x_i'\beta|} &= sign(y_i-x_i'\beta) \\            
\end{aligned}
\]

Under the assumption \(\varepsilon_i \times x\gamma\), or in this case
\(y_i-x_i'\beta\), is uncorrelated with \(x\), we can simplify the
expression as:

\[\begin{aligned}
\bar G_{2,1} &= N^{-1} \left(N^{-1}\sum sign(y_i-x_i'\beta)\right) \sum x_i x_i' \\
&= N^{-1} E[sign(y_i-x_i'\beta)] X'X
\end{aligned}
\]

\[\begin{aligned}
\bar G_{2,2} &= -\frac{1}{N} \sum \frac{\partial h_{2,i}}{\partial \gamma'} \\
             &=  \frac{1}{N} \sum x_i x_i' 
             &= N^{-1} X'X
\end{aligned}
\]

\[\bar G_{2,3}=0\]

\hypertarget{third-moment-condition-quantile-of-standardized-residual}{%
\subsubsection{Third Moment Condition: Quantile of Standardized
Residual}\label{third-moment-condition-quantile-of-standardized-residual}}

\[\begin{aligned}
h_{3,i} &= \mathbb{1}\left( q^\varepsilon_\tau x_i'\gamma +x_i'\beta - y_i \geq 0 \right) - \tau \text{ or}\\
h_{3,i} &= \mathbb{1}\left( q^\varepsilon_\tau  \geq \frac{y_i- x_i'\beta}{x_i'\gamma}  \right) - \tau = \mathbb{1}\big( q^\varepsilon_\tau  \geq \varepsilon  \big) - \tau \\
\end{aligned}
\]

Because the indicator function \(\mathbb{1}()\) is not differentiable,
we borrow from the non-parametric literature, and approximate the
indicator function with the integral of a kernel density function
\(I()\). This function \(I()\), is monotonic and symetrical function
around zero, with a domain over the real numbers, and a range between 0
and 1.

With an arbirarily small bandwidth \(h\), this function will approximate
the indicator function:

\[
\lim_{h\rightarrow 0} I\left(\frac{z}{h}\right) \approx \mathbb{1}(z\geq 0)
\]

Thus the function \(h_{3,i}\) can be approximated as:

\[h_{3,i} \approx I\left( q^\varepsilon_\tau x_i'\gamma +x_i'\beta - y_i  \right) - \tau\]

Now, we can obtain the Jacobian matrix \(\bar G_{3,1}\) as:

\[\begin{aligned}
\bar G_{3,1} &= -\frac{1}{N} \sum \frac{\partial h_{3,i}}{\partial \beta'} \\
             &= -N^{-1} \sum K_h(q^\varepsilon_\tau x_i'\gamma +x_i'\beta - y_i ) x_i'
\end{aligned}
\]

Under the assumption that we have enough observations within each
combination of \(x\), and of multiplicative heteroskedasticity, we have:

\[\begin{aligned}
E(K_h(q^\varepsilon_\tau x_i'\gamma +x_i'\beta - y_i )|X) &= f_{y|X}(q^\varepsilon_\tau x_i'\gamma +x_i'\beta) \\
&=\frac{1}{x_i'\gamma} f_{\varepsilon}(q^\varepsilon_\tau) \\
\end{aligned}
\]

where \(f_{y|X}\) is the conditional probability density function of
\(y\) given \(X\), and \(f_\varepsilon\) is the unconditional
distribution of the standardized error. With this, we can rewrite the
Jacobian matrix as:

\[\bar G_{3,1} = -N^{-1} f_{\varepsilon}\big(q^\varepsilon_\tau\big) \sum  \frac{x_i'}{x_i'\gamma} 
\]

Asymptotically, however, the expression \(\sum\frac{a_i}{b_i}\) can be
approximated using taylor expansions by \(N\frac{\bar a}{\bar b}\).
\footnote{This approximation will be useful when we consider the
  estimation of the influence functions.} Thus, we can rewrite the last
term as:

\[\bar G_{3,1} = - f_{\varepsilon}\big(q^\varepsilon_\tau\big) \frac{\bar x_i'}{\bar x_i'\gamma} 
\]

The Jacobian for the second matrix \(\bar G_{3,2}\) can be derived
similarly:

\[\begin{aligned}
\bar G_{3,2} &= -\frac{1}{N} \sum \frac{\partial h_{3,i}}{\partial \gamma'} \\
             &= -N^{-1} \sum K_h(q^\varepsilon_\tau x_i'\gamma +x_i'\beta - y_i ) q^\varepsilon_\tau x_i' \\
             &=-N^{-1} \sum f_{y|x}(q^\varepsilon_\tau x_i'\gamma +x_i'\beta ) q^\varepsilon_\tau x_i' \\
             &=-N^{-1} f_{\varepsilon}(q^\varepsilon_\tau) q^\varepsilon_\tau \sum \frac{x_i'}{x_i'\gamma} \\
             &=- f_{\varepsilon}(q^\varepsilon_\tau) q^\varepsilon_\tau \frac{\bar x_i'}{\bar x_i'\gamma}
\end{aligned}
\]

and the Jacobian for the third matrix \(\bar G_{3,3}\) is:

\[\begin{aligned}
\bar G_{3,3} &= -\frac{1}{N} \sum \frac{\partial h_{3,i}}{\partial q^\varepsilon_\tau} \\
 &= -\frac{1}{N} \sum K_h(q^\varepsilon_\tau x_i'\gamma +x_i'\beta - y_i ) x_i'\gamma \\
 &= -\frac{1}{N} \sum f_{y|X}(q^\varepsilon_\tau x_i'\gamma +x_i'\beta) x_i'\gamma \\
 &= -\frac{1}{N} \sum f_{\varepsilon}(q^\varepsilon_\tau) \frac{x_i'\gamma}{ x_i'\gamma} \\
 &= - f_{\varepsilon}(q^\varepsilon_\tau) 
\end{aligned}
\]

\hypertarget{influence-functions}{%
\subsection{Influence functions}\label{influence-functions}}

\hypertarget{location-coefficients}{%
\subsubsection{Location coefficients}\label{location-coefficients}}

\[\lambda_i(\beta) = \bar G^{-1}_{1,1} h_{1,i} = N (X'X)^{-1}(x_i (y_i-x_i'\beta)) = N (X'X)^{-1}(x_i \nu_i)
\]

Which can also be written as a function of the standardized residuals:

\[\lambda_i(\beta) = \bar G^{-1}_{1,1} h_{1,i} = N (X'X)^{-1}(x_i (y_i-x_i'\beta)) = N (X'X)^{-1}(x_i ( x_i'\gamma \times \varepsilon))
\]

\hypertarget{scale-coefficients-coefficients}{%
\subsubsection{Scale Coefficients
coefficients**}\label{scale-coefficients-coefficients}}

\[\begin{aligned}
\lambda_i(\gamma)&=\bar G_{2,2}^{-1}\Big(h_{2,i}-\bar G_{2,1} \lambda_i(\beta)\Big) \\
&=N (X'X)^{-1} \Big(x_i(|\nu_i|-x_i' \gamma) 
- N^{-1} E[sign(\nu_i)] X'X \big[ N (X'X)^{-1}(x_i \nu_i) \big] \Big) \\
&=N (X'X)^{-1} \Big(x_i(|\nu_i|-x_i' \gamma) - E[sign(\nu_i)] (x_i \nu_i)  \Big) \\
&=N (X'X)^{-1} x_i \Big( |\nu_i| - E[sign(\nu_i)] \nu_i -x_i' \gamma \Big) 
\end{aligned}
\]

However,

\[\begin{aligned}
|\nu_i| &= \nu_i \times \mathbb{1}(\nu_i \geq 0) - \nu_i \times \mathbb{1}(\nu_i < 0) \\
|\nu_i| &= \nu_i \times \mathbb{1}(\nu_i \geq 0) - \nu_i \times [1-\mathbb{1}(\nu_i \geq 0)] \\
|\nu_i| &= 2 \nu_i \times \mathbb{1}(\nu_i \geq 0) - \nu_i  
\end{aligned}
\]

And \[\begin{aligned}
E[sign(\nu_i)] &= E[\mathbb{1}(\nu_i \geq 0)] - E[\mathbb{1}(\nu_i < 0)] \\
E[sign(\nu_i)] &= E[\mathbb{1}(\nu_i \geq 0)] - E[(1-\mathbb{1}(\nu_i \geq 0))] \\
E[sign(\nu_i)] &= 2 E[\mathbb{1}(\nu_i \geq 0)] - 1
\end{aligned}
\]

Thus,

\[\begin{aligned}
\lambda_i(\gamma) &= N(X'X)^{-1} x_i   \Big( 2 \nu_i \times \mathbb{1}(\nu_i \geq 0) - \nu_i  - ( 2 E[\mathbb{1}(\nu_i \geq 0)] - 1) \nu_i -x_i' \gamma \Big) \\
  &= N(X'X)^{-1} x_i   \Big( 2 \nu_i \times \mathbb{1}(\nu_i \geq 0) -  2 E[\mathbb{1}(\nu_i \geq 0)] \nu_i -x_i' \gamma \Big) \\
  &= N(X'X)^{-1} x_i   \Big( 2 \nu_i \times \big[ \mathbb{1}(\nu_i \geq 0) -  E[\mathbb{1}(\nu_i \geq 0)] \big] -x_i'\gamma \Big) \\
  &= N(X'X)^{-1} x_i   \Big( \tilde \nu_i -x_i' 
  \gamma \Big)
\end{aligned}
\]

This last expression is the equivalent simplification used in
\citet{mss2019} and \citet{im2000}. If the scale function is strictly
possitive, it also follows that
\(\mathbb{1}(\nu_i \geq 0)= \mathbb{1}(\varepsilon_i \geq 0)\). Thus, it
can be simplified as:

\[\begin{aligned}
\lambda_i(\gamma) &= N(X'X)^{-1} x_i ( x_i' \gamma ) \times (\tilde \varepsilon_i -1\big)
\end{aligned}
\]

\hypertarget{quantile-of-standardized-residual}{%
\subsubsection{Quantile of standardized
residual}\label{quantile-of-standardized-residual}}

\[\begin{aligned}
\lambda_i(q^\varepsilon_\tau)&=\bar G_{3,3}^{-1}
\Big(
 h_{3,i}-\bar G_{3,1} \lambda_i(\beta)-\bar G_{3,2} \lambda_i(\gamma)
\Big) \\
&=-\frac{1}{f_{\varepsilon}(q^\varepsilon_\tau)} \times \Bigg( \Big(\mathbb{1} ( q^\varepsilon_\tau  \geq \varepsilon  ) - \tau \Big)  \\
&+ f_{\varepsilon} (q^\varepsilon_\tau) \frac{\bar x_i'}{\bar x_i'\gamma} 
N (X'X)^{-1} x_i  ( x_i'\gamma \times \varepsilon) \\
&+ f_{\varepsilon}(q^\varepsilon_\tau) q^\varepsilon_\tau \frac{\bar x_i'}{\bar x_i'\gamma} N(X'X)^{-1} x_i   \big( \tilde \nu_i -x_i' 
  \gamma \big) 
\Bigg) \\
&=\frac{\tau-\mathbb{1}\big( q^\varepsilon_\tau  \geq \varepsilon  \big) }{f_{\varepsilon}(q^\varepsilon_\tau)}
- \frac{ x_i'\gamma \times \varepsilon_i }{\bar x_i'\gamma} 
-  q^\varepsilon_\tau \frac{ \tilde \nu_i -x_i' 
  \gamma }{\bar x_i'\gamma} 
\end{aligned}
\]


\renewcommand\refname{References}
  \bibliography{bibliography.bib}


\end{document}
