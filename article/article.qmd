---
title: Quantile Regressions via Method of Moments with multiple fixed effects
author:
  - name: Fernando Rios-Avila
    email: friosavi@levy.org
    affiliations: 
        - id: levy
          name: Levy Economics Institute of Bard College          
    attributes:
        corresponding: true
  - name: Leonardo Siles
    email: leo@gmail.com
  - name: Gustavo Canavire-Bacarreza
    email: gcanavire@worldbank.org
    affiliations:
        - id: wb
          name: World Bank
abstract: |
  This paper proposes a new method to estimate quantile regressions with multiple fixed effects. The method expands on the strategy proposed by @mss2019, allowing for multiple fixed effects, and providing various alternatives for the estimation of Standard errors. We provide Monte Carlo simulations to show the finite sample properties of the proposed method in the presence of two sets of fixed effects. Finally, we apply the proposed method to estimate **something interesting**
keywords: 
  - Fixed effects
  - Linear heteroskedasticity
  - Location-scale model
  - Quantile regression

date: last-modified
bibliography: bibliography.bib
format:
  elsevier-pdf:
    keep-tex: true
    journal:
      name: Journal Name
      formatting: preprint
      model: 1p
      cite-style: authoryear
---

# Introduction

Quantile regression (QR), introduced by @koenkerbasset1978, is an estimation strategy used for modeling the relationships between explanatory variables X and the conditional quantiles of the dependent variable $q_\tau (y|x)$. Using QR one can obtain richer characterizations of the relationships between dependent and independent variables, by accounting for otherwise unobserved heterogeneity. 

A relatively recent development in the literature has focused on extending quantile regressions analysis to include individual fixed effects in the framework of panel data. However, as described in @neymanscott1948, and @lancaster2000, when individual fixed effects are included in quantile regression analysis it generates an incident parameter problem. While many strategies have been proposed for estimating this type of model (see Galvão and Kato, 2018 for a brief review), neither has become standard because of their restrictive assumptions in regards to the individual effects, the computational complexity, and implementation. 

More recently, @mss2019 (MSS hereafter) proposed a methodology based on a conditional location-scale model similar to the one described in @he1997 and @zhao2000, for the estimation of quantile regressions models for panel data via a method of moments. This method allows individual fixed effects allowing to have heterogeneous effects on the entire conditional distribution of the outcome, rather constraining their effect to be a location shift only as in @canay2011, @koenker2004, and @lancaster2000. 

In principle, under the assumption that data generating process behind the data is based on a multiplicative heteroskedastic process that is linear in parameters (@cameron2005, @mss2019, @he1997 and @zhao2000 ), the effect of a variable $X$ on the $q_th$ quantile can be derived as the combination of a location effect, and scale effect moderated by the quantile of an underlying i.i.d. error. For statistical inference, MSS derives the asymptotic distribution of the estimator, suggesting the use of bootstrap standard errors, as well.

While this methodology is not meant to substitute the use of standard quantile regression analysis, given the assumptions required for the identification of the model, it provides a simple and fast alternative for the estimation of quantile regression models with individual fixed effects. 

In this framework, our paper expands on @mss2019, following some of the suggestions by the authors regarding further research. First, making use of the properties of GMM estimators, we derive various alternatives for the estimation of standard errors based on the empirical Influence functions of the estimators. Second, we reconsider the application of Frisch–Waugh–Lovell (FWL) theorem (@frishwaugh1933 and @lovell1963) to extend the MSS estimator to allow for the inclusion of multiple fixed effects, for example, individual and year fixed effects. 

The rest of the paper is restructured as follows. Section 2 presents the basic setup of the location-Scale model described in @he1997 and @zhao2000, tying the relationship between the standard quantile regression model, and the location and scale model. It also revisits MSS methodology, proposing alternative estimators for the standard errors based on the properties of GMM estimators and the empirical influence functions. It also shows that FWL theorem can be used to control for multiple fixed effects. Section 3 presents the results of a small simulation study and Section 4 illustrates the application of the proposed methods with two empirical examples. Seccion 5 concludes. 

# Methodology

## Quantile Regression: Location-Scale model {#sec-betas}

Quantile regressions are used to identify relationships between the explanatory variables $x$ and the conditional quantiles of the dependent variable $Q(y|\tau,X)$. This relationship is commonly assumed to follow a linear functional form:

$$Q(Y|X,\tau) =X\beta(\tau)
$${#eq-eq1}

This allows for nonlinearities in the effect of $X$ on $Y$ across all values of $\tau$. This formulation can also be related to a random coefficient model, where all coefficients are assumed to be some nonlinear function of $\tau$, where $\tau$ follows a random uniform distribution.

An alternative formulation of quantile regressions is the location-scale model. This approach assumes that the conditional quantile of $Y$ given $X$ and $\tau$ can be expressed as a combination of two models: the location model, which describes the central tendency of the conditional distribution, and the scale model, which describes deviations from the central tendency:

$$Q(Y|X,\tau) =X\beta+X\gamma(\tau)
$${#eq-eq2}

Here, the location parameters $\beta$ are typically identified using a linear regression model (as in @mss2019), or a median regression (as in @melly2005), and the scale parameters $\gamma(\tau)$ can be estimated using standard approaches.

Both the standard quantile regression (@eq-eq1) and the location-scale specification (@eq-eq2) can be estimated as the solution to a weighted minimization problem:

$$\hat{\beta}(\tau) = \underset{\beta}{\operatorname{argmin}}
\left( \sum_{i\in y_i\geq x_i'\beta} \tau (y_i - x_i'\beta) - \sum_{i\in y_i<x_i'\beta} (1-\tau)(y_i - x_i'\beta) \right)
$${#eq-eq3}

One characteristic of this estimator is that the $\beta(\tau)$ coefficients are identified locally, and thus the estimated quantile coefficients will exhibit considerable variation when analyzed across $\tau$. It is also implicit that if one requires an analysis of the entire distribution, it would be necessary to estimate the model for each quantile.[^1]

[^1]: There are other estimators that provide smoother estimates for the quantile regression coefficients using a kernel local weighted approach [@kaplan2017], as well as identifying the full set of quantile coefficients simultaneously assuming some parametric functional forms [@frumentobotai2016].

One insightful extension to the location-scale parameterizations suggested by @he1997, @cameron2005, and @mss2019 is to assume that the data-generating process (DGP) can be written as a linear model with a multiplicative heteroskedastic process that is linear in parameters.[^2]

$$y_i=x_i'\beta+\varepsilon_i \times x_i'\gamma(\tau)
$${#eq-eq4}

[^2]: @mss2019 also discuss a model where heteroskedasticity can be an arbitrary nonlinear function $\sigma(x_i'\gamma)$, but develop the estimator for the linear case, i.e., when $\sigma()$ is the identity function.

Under the assumption that $\varepsilon$ is an independent and identically distributed (iid) unobserved random variable that is independent of $X$, the conditional quantile of $Y$ given $X$ and $\tau$ can be written as:

$$Q(Y|X,\tau) =X\beta+X\gamma \times Q(\varepsilon|\tau)
$${#eq-eq5}

In this setup, the traditional quantile coefficients are identified as the location model coefficients, plus the scale model coefficients moderated by the $\tau_th$ unconditional quantile of the standardized error $\varepsilon$.

$$\beta(\tau) = \beta + \gamma \times Q(\varepsilon|\tau)
$${#eq-eq6}

While this specification imposes a strong assumption on the DGP, it has two advantages over the standard quantile regression model. First, because the location and scale model can be identified globally, with only a single parmater ($Q(\varepsilon|\tau)$) requiring local estimation, this estimation approach would be more efficient than the standard quantile regression model (@zhao2000). Second, under the assumption that $X\gamma$ is strictly possitive, the model would produce quantile coefficients that do not cross. 

Following MSS, the quantile regression model defined by @eq-eq5 can be estimated using a method of moments approach. And while its possible to identify all coefficients ($\beta,\gamma, Q(\varepsilon|\tau)$) simultaneously, we describe and use the implementation approach advocated by MSS which identifies each set of coefficients separately.

1. The location model can be estimated using a standard linear regression model, where the dependent variable is the outcome $Y$, and the independent variables are the explanatory variables $X$ (including a constant) with an error $u$, which is by definition heteroskedastic. In this case, the location model coefficients are identified under the following condition:
$$\begin{aligned}
  y_i &=x_i'\beta+u_i \\
  E[u 'X ] &=0
  \end{aligned}
$${#eq-eq7}

2. After the location model is estimated, the scale coefficients can be identified by modeling heteroskedasticity as a linear function of characteristics $X$. For this we use the absolute value of the errors from the location model $u$ as dependent variable, which would allow us to estimate the conditional standard deviation (rather than conditional variance) of the errors. In this case, the coefficients are identified under the following condition: 

$$\begin{aligned}
  |u_i| &=x_i'\gamma+v_i \\
  E[ (|u|-X \gamma) X ] &=0
  \end{aligned}
$${#eq-eq8}

3. Finally, given the location and scale coefficients, the $\tau_{th}$ quantile of the error $e$ can be estimated using the following condition:

$$\begin{aligned}
  E\left[  \mathbb{1}\left(x_i' (\beta + \gamma Q(\varepsilon|\tau)) \geq y_i \right) - \tau \right] &=0  \\
  E\left[  \mathbb{1}\left(   Q(\varepsilon|\tau)\geq \frac{y_i-x_i'\beta}{x_i'\gamma} \right) - \tau \right] &=0  \\
  \end{aligned}
$${#eq-eq9}

Where one identifies the quantile of the error $\varepsilon$ using standardized errors $\frac{y_i-x_i'\beta}{x_i'\gamma}$, or by finding the values that identify the overall quantile coefficients $\beta(\tau)=\beta + \gamma Q(\varepsilon|\tau)$. Afterwords, the conditional quantile coefficients is simply defined as the combination of the location and scale coefficients.

## Standard Errors: GLS, Robust, Clustered {#sec-se}

As discussed in the previous section, the estimation of quantile regression coefficients using the location-scale model with heteroskedstic linear errors can be estimated using a the following set of moments, which fits in the Generalized Method of Moments framework:

$$\begin{aligned}
  E[u_i x_i ] &= E[h_{1,i}]=0 \\
  E[ (|u_i|-x_i \gamma) x_i ] &=E[h_{2,i}]=0 \\
  E\left[  \mathbb{1}\left(   Q(\varepsilon|\tau)\geq \frac{y_i-x_i'\beta}{x_i'\gamma} \right) - \tau \right] 
  &=E[h_{3,i}]=0 
  \end{aligned}
$${#eq-eq10}

Under the conditions described in @newey_chapter_1994 (see section 7), @cameron2005 (see chapter 6.3.9) or as shown in @mss2019, the location, scale and residual quantile coefficients are asymptotically normal.[^3] 

[^3]: @zhao2000 also shows that the quantile coefficients for the location-scale model also follows a normal distribution, but uses the assumption that the location model is derived using a least absolute deviation approach (median regression).

Call $\theta=[ \beta' \ \ \gamma'  \ \ Q(\varepsilon|\tau)' ]'$ the set of coefficients that are identified in @eq-eq10, a just identified model.  And the function $h_i$ is a vector function that stacks all the moments at the individual level described in @eq-eq10. Then $\hat\theta$ follows a normal distribution with mean $\theta$ and variance-covariance matrix $V(\theta)$ that is estimated as:
$$
\hat{V}(\hat\theta)=\frac{1}{N} 
\bar G(\hat\theta)^{-1} 
\left( \frac{1}{N} \sum_{i=1}^N h_i h_i'  \Big|_{\theta=\hat\theta} \right) 
\bar G(\hat\theta)^{-1} 
$$

where the inner product is the moment covariance matrix, and $\bar{G}(\theta)$ is the Jacobian matrix of the moment equations (@eq-eq10) evaluated at $\hat\theta$.

$$\bar{G}(\theta) =-\frac{1}{N} \sum_{i=1} \frac{\partial h_i}{\partial \theta'} \Big|_{\theta=\hat\theta}$$

This is equivalent to the Eicker-White Heteroskedastic-Consistent estimator for least-squares estimators. 

In this framework, the quantile regression coefficients, a combination of the location-scale-quantile estimates, will follow a normal distribution with mean $\beta(\tau) = \beta+Q(\varepsilon,\tau)\gamma$ and variance-covariance matrix equal to:

$$\hat{V}(\beta(\tau)) = \Xi \hat{V}(\hat\theta) \Xi'
$$

where $\Xi$ is a $k \times (2k+1)$ matrix defined as:

$$\Xi = [ I(k), \hat Q(\varepsilon|\tau) \cdot I(k), \hat \gamma ]
$$
 
with $I(k)$ being an identity matrix of dimension $k$ (number of explanatory variables in $X$ including the constant).

The different types of Standard errors estimation, thus, depend on the assumptions imposed for the estimation of $V(\theta)$. 

## Multiple Fixed Effects: Expanding on @mss2019

Using the setup described in the previous section, @mss2019 proposes an extension to the model proposed by @he1997 that would allow for the estimation of quantile regression models with panel data, allowing for the inclusion of individual fixed effects. However, as the authors suggest, the methodology can be generalized to allow for the inclusion of multiple fixed effects. This type of analysis may be useful when considering data such as employer-employee linked data [@abowed2006], or teacher-student linked data [@harrissass2011]. Or, in the most common case, allowing to control for both individual and time fixed effects.

Reconsider the original model, and assume there are sets of unobserved heterogeneity that are assumed to be constant across observations, if they belong to common groups. In panel data, the groups would be the individual fixed effects and the time fixed effects. Without loss of generality, we can assume that the data generating process is as follows:

$$\begin{aligned}
  y_{i} &= x_{i}' \beta + \delta_{g1} + \delta_{g2} + \nu_i \\
  \nu_i &= \varepsilon_i \times (x_{i}' \gamma + \zeta_{g1} + \zeta_{g2})   
  \end{aligned}
$$

where we assume $x_{i}$ vary across groups $g_1$ and $g_2$, thus are not collinear, and that $\delta's$ and $\zeta's$ are the location and scale effects associated with groups fixed effects.[^4]

[^4]: We could just as well consider multiple sets of fixed effects

If the dimension of groups $g_k$ is low, this model could be estimated using a dummy inclussion approach following @sec-betas, and standard errors obtained as discussed in @sec-se. However, if the dimensionality of $g_k$ is high, the dummy inclusion approach may not be feasible. Instead, a more feasible approach is to apply the Frisch-Waugh-Lovell (FWL) theorem, and partial out the impact of the group fixed effects on the control variables $x_{i}$, the outcome of interest $y_{i}$, with a similar approach for the identification of $\sigma(x)$. In the case of unbalanced setups, with multiple groups, the estimation involves iterative processes for which various approaches have been suggested and implemented (see @correia_feasible_nodate, @gaure2013, @rios2015, among others).

When applying the partialing out approach, some modifications to the approach described in @sec-betas are needed.

1. For all dependent and independent variables in the model ($w=y,x$), we partial out the group fixed effects, and obtain the centered-residualized variables:

$$\begin{aligned}
w_{i} &= \delta_{g1}^w + \delta_{g2}^w + u_{i}^w \\
w_{i}^{rc} &= E(w_{i}) + \hat{u}_{i}^w
\end{aligned}
$$

2. We estimate the location model using the centered-residualized variables:
    
$$y_{i}^{rc} = x_{i}^{rc'} \beta + nu_{i}
$$

3. Since $|\hat \nu_i|$ is the dependent variable for the scale model, we apply the partialling out and recentering to this expression ($|\hat \nu_i|^{rc}$), and use that to estimate the model:
  
$$|\hat\nu_{i}|^{rc} = x_{i}^{rc'} \gamma + e_{i}$$

4. Finally the standardized residuals $\varepsilon_i$ can be obtained as follows 

$$\hat{\varepsilon}_{i} = \frac{\nu_{i}}{|\hat\nu_{i}|- \hat e_{i}}$$

where $|\hat\nu_{i}|- \hat e_{i}$ is the prediction for the conditional standard deviation $\sigma(x_i)=x_{i}' \gamma + \zeta_{g1} + \zeta_{g2}$
    
The $\tau_{th}$ quantile of the error $\varepsilon$ can be estimated as usual, and the variance-covariance matrices obtained in the same way as before (see @sec-se), but using  $x_{i}^{rc}$ instead of $x_{i}$ when estimating the influence functions for all estimated coefficients. 

# Monte Carlo Simulations

# Application: **Something interesting**

# Conclusions

# Appendix {.appendix} 

The estimation of quantile regression via moments assumes that the DGP is linear in parameters, with an heteroskedastic error term that is also linear function of parameters:

$$\begin{aligned}
y = x\beta + \nu \\
\nu = \varepsilon \times x\gamma
\end{aligned}
$$

where $\varepsilon$ is an unobserved i.i.d. random variable that is independent of $x$, and such that $x\gamma$ is larger than zero for any $x$.

In this case, the $\tau_{th}$ conditional quantile model can be written as:

$$q(y|\tau,X) = x(\beta + q(e|\tau) \times \gamma)$$

This model is identified under the following conditions:

$$\begin{aligned}
  E[(y_i-x_i'\beta)x_i ]  &= E[h_{1,i}]=0 \\
  E[ (|y_i-x_i'\beta|-x_i' \gamma) x_i ] &=E[h_{2,i}]=0 \\
  E\left[  \mathbb{1}\left( q(\varepsilon|\tau) x_i'\gamma +x_i'\beta\geq  y_i  \right) - \tau \right] 
   &=E[h_{3,i}]=0 
\end{aligned}
$$

In this model, to estimate the variance-covariance matrix the set of coefficients $\theta'=[\beta' \ \gamma' \ q(\varepsilon|\tau)']$, we need to obtain the influence functions of all coefficients, which are defined as:

$$\lambda_i = \bar G(\theta)^{-1}
\begin{bmatrix}
h_{1,i} \\
h_{2,i} \\
h_{3,i}
\end{bmatrix}
$$

where the Jacobian matrix $\bar G(\theta)$ is defined as:

$$\bar G(\theta) = \begin{bmatrix}
\bar G_{11} & G_{12} & G_{13} \\
\bar G_{21} & \bar G_{22} & G_{23} \\
\bar G_{31} & \bar G_{32} & \bar G_{13} \\
\end{bmatrix}
$$ 

with 

$$\bar G_{j,k} = - \frac 1 N \sum_{i=1}^N \frac{\partial h_{j,i}}{\partial \theta_k'} \ \forall j,k \in 1,2,3
$$

### First Moment Condition: Location Model

$$h_{1,i}=x_i(y_i-x_i'\beta)$$

$$\begin{aligned}
\bar G_{1,1} &=- \frac{1}{N} \sum_{i=1}^N \frac{\partial h_{1,i}}{\partial \beta'} \\
             &=- \frac{1}{N} \sum_{i=1}^N (-x_i x_i') \\
             &= N^{-1} X'X
\end{aligned}
$$

$$
\bar G_{1,2} = \bar G_{1,3} = 0
$$


### Second Moment Condition: Scale model

$$h_{2,i}=x_i(|y_i-x_i'\beta|-x_i'\gamma)$$

$$\begin{aligned}
\bar G_{2,1} &= -\frac{1}{N} \sum \frac{\partial h_{2,i}}{\partial \beta'} \\
             &=  \frac{1}{N} \sum x_i x_i' \frac{y_i-x_i'\beta}{|y_i-x_i'\beta|} \\
\frac{y_i-x_i'\beta}{|y_i-x_i'\beta|} &= sign(y_i-x_i'\beta) \\            
\end{aligned}
$$

Under the assumption $\varepsilon_i \times x\gamma$, or in this case $y_i-x_i'\beta$, is uncorrelated with $x$, we can simplify the expression as:

$$\begin{aligned}
\bar G_{2,1} &= N^{-1} \left(N^{-1}\sum sign(y_i-x_i'\beta)\right) \sum x_i x_i' \\
&= N^{-1} E[sign(y_i-x_i'\beta)] X'X
\end{aligned}
$$

$$\begin{aligned}
\bar G_{2,2} &= -\frac{1}{N} \sum \frac{\partial h_{2,i}}{\partial \gamma'} \\
             &=  \frac{1}{N} \sum x_i x_i' 
             &= N^{-1} X'X
\end{aligned}
$$

$$\bar G_{2,3}=0$$

### Third Moment Condition: Quantile of Standardized Residual 

$$h_{3,i} = \mathbb{1}\left( q(\varepsilon|\tau) x_i'\gamma +x_i'\beta - y_i \geq 0 \right) - \tau$$

Because the indicator function $\mathbb{1}()$ is not differentiable, we impose some smoothing assumptions:

First:

$$\begin{aligned}
E[h_{3,i}] -\tau &= E[\mathbb{1}\left( q(\varepsilon|\tau) x_i'\gamma +x_i'\beta - y_i \geq 0 \right)] - \tau \\
                &= E\left[E[\mathbb{1}\left( q(\varepsilon|\tau) x_i'\gamma +x_i'\beta - y_i \geq 0 \right)|x]\right] - \tau
\end{aligned}
$$

Because we are aiming to identify the conditional quantile function of $y$, and under the assumption of the DGP it follows that:

$$\begin{aligned}
q(y|\tau) &= q(\varepsilon|\tau) x_i'\gamma +x_i'\beta \\
E[\mathbb{1}\left( q(y|\tau) - y_i \geq 0 \right)|x] &= \tau 
\end{aligned}
$$

and asymptotically, we expect that 

$$E[\mathbb{1}\left( q(y|\tau) - y_i \geq 0 \right)|x]=
E[\mathbb{1}\left( q(y|\tau) \geq  y_i \right)|x] = \tau = F_{y |X} \big( q(y|\tau) \big) 
$$

but also that 

$$F_{y|X} \big( q(y|\tau)) = \tau = F_{\varepsilon}( q(\varepsilon|\tau) )
$$

where $F_{y|X}$ is the conditional cumulative distribution function (CDF) of $y$, and $F_{\varepsilon}$ is the unconditonal CDF of the iid error $\varepsilon$.

Second, based on non-parametric estimation of the CDF, we can approximate $F_{y|X} \big( q(y|\tau))$ as:

$$F_{y|X} \big( q(y|\tau) ) \approx \frac{\sum_{i=1}^N F_{y|X) ( q(y|\tau) - y_i) 




# References {-}